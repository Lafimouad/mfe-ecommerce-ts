name: Deploy MFE to AWS

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  NODE_VERSION: "18"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mfe:
          - name: mfe-products
            port: 3001
          - name: mfe-cart
            port: 3002
          - name: mfe-checkout
            port: 3003
          - name: mfe-auth
            port: 3004
          - name: mfe-search
            port: 3005
          - name: mfe-wishlist
            port: 3006
          - name: mfe-orders
            port: 3007
          - name: mfe-ui
            port: 3008
          - name: mfe-store-host
            port: 3000

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: ${{ matrix.mfe.name }}
        run: npm install

      - name: Build MFE
        working-directory: ${{ matrix.mfe.name }}
        run: npm run build
        env:
          NODE_ENV: production
          # URLs will be injected from Terraform outputs
          REACT_APP_MFE_HOST_URL: ${{ secrets.MFE_HOST_URL }}
          REACT_APP_MFE_PRODUCTS_URL: ${{ secrets.MFE_PRODUCTS_URL }}
          REACT_APP_MFE_CART_URL: ${{ secrets.MFE_CART_URL }}
          REACT_APP_MFE_CHECKOUT_URL: ${{ secrets.MFE_CHECKOUT_URL }}
          REACT_APP_MFE_AUTH_URL: ${{ secrets.MFE_AUTH_URL }}
          REACT_APP_MFE_SEARCH_URL: ${{ secrets.MFE_SEARCH_URL }}
          REACT_APP_MFE_WISHLIST_URL: ${{ secrets.MFE_WISHLIST_URL }}
          REACT_APP_MFE_ORDERS_URL: ${{ secrets.MFE_ORDERS_URL }}
          REACT_APP_MFE_UI_URL: ${{ secrets.MFE_UI_URL }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        working-directory: ${{ matrix.mfe.name }}
        run: |
          # Map MFE names to Terraform bucket names (remove mfe- prefix and use short names)
          case "${{ matrix.mfe.name }}" in
            "mfe-store-host") BUCKET_SUFFIX="host" ;;
            "mfe-products") BUCKET_SUFFIX="products" ;;
            "mfe-cart") BUCKET_SUFFIX="cart" ;;
            "mfe-checkout") BUCKET_SUFFIX="checkout" ;;
            "mfe-auth") BUCKET_SUFFIX="auth" ;;
            "mfe-search") BUCKET_SUFFIX="search" ;;
            "mfe-wishlist") BUCKET_SUFFIX="wishlist" ;;
            "mfe-orders") BUCKET_SUFFIX="orders" ;;
            "mfe-ui") BUCKET_SUFFIX="ui" ;;
          esac
          BUCKET_NAME="${{ secrets.S3_BUCKET_PREFIX }}-${BUCKET_SUFFIX}-prod"

          # Sync all files except index.html and remoteEntry.js with cache
          aws s3 sync dist/ "s3://${BUCKET_NAME}" \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "remoteEntry.js"

          # Upload index.html without cache
          if [ -f "dist/index.html" ]; then
            aws s3 cp dist/index.html "s3://${BUCKET_NAME}/index.html" \
              --cache-control "no-cache, no-store, must-revalidate"
          fi

          # Upload remoteEntry.js without cache
          if [ -f "dist/remoteEntry.js" ]; then
            aws s3 cp dist/remoteEntry.js "s3://${BUCKET_NAME}/remoteEntry.js" \
              --cache-control "no-cache, no-store, must-revalidate"
          fi

      - name: Invalidate CloudFront cache
        run: |
          # Map MFE names to short names for CloudFront lookup
          case "${{ matrix.mfe.name }}" in
            "mfe-store-host") MFE_KEY="host" ;;
            "mfe-products") MFE_KEY="products" ;;
            "mfe-cart") MFE_KEY="cart" ;;
            "mfe-checkout") MFE_KEY="checkout" ;;
            "mfe-auth") MFE_KEY="auth" ;;
            "mfe-search") MFE_KEY="search" ;;
            "mfe-wishlist") MFE_KEY="wishlist" ;;
            "mfe-orders") MFE_KEY="orders" ;;
            "mfe-ui") MFE_KEY="ui" ;;
          esac
          DISTRIBUTION_ID=$(echo '${{ secrets.CLOUDFRONT_DISTRIBUTION_IDS }}' | jq -r ".\"${MFE_KEY}\"")
          if [ "$DISTRIBUTION_ID" != "null" ] && [ -n "$DISTRIBUTION_ID" ]; then
            echo "Invalidating CloudFront distribution: $DISTRIBUTION_ID"
            
            # Retry logic for CloudFront rate limiting
            MAX_RETRIES=5
            RETRY_COUNT=0
            RETRY_DELAY=10
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if aws cloudfront create-invalidation \
                --distribution-id "$DISTRIBUTION_ID" \
                --paths "/*" 2>&1; then
                echo "‚úÖ CloudFront invalidation successful"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "‚ö†Ô∏è  CloudFront invalidation failed, retrying in ${RETRY_DELAY}s... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                  sleep $RETRY_DELAY
                  RETRY_DELAY=$((RETRY_DELAY * 2))  # Exponential backoff
                else
                  echo "‚ùå CloudFront invalidation failed after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          else
            echo "No CloudFront distribution found for ${MFE_KEY}, skipping invalidation"
          fi

      - name: Deployment status
        run: |
          echo "‚úÖ ${{ matrix.mfe.name }} deployed successfully!"
          case "${{ matrix.mfe.name }}" in
            "mfe-store-host") BUCKET_SUFFIX="host" ;;
            "mfe-products") BUCKET_SUFFIX="products" ;;
            "mfe-cart") BUCKET_SUFFIX="cart" ;;
            "mfe-checkout") BUCKET_SUFFIX="checkout" ;;
            "mfe-auth") BUCKET_SUFFIX="auth" ;;
            "mfe-search") BUCKET_SUFFIX="search" ;;
            "mfe-wishlist") BUCKET_SUFFIX="wishlist" ;;
            "mfe-orders") BUCKET_SUFFIX="orders" ;;
            "mfe-ui") BUCKET_SUFFIX="ui" ;;
          esac
          echo "üì¶ Bucket: ${{ secrets.S3_BUCKET_PREFIX }}-${BUCKET_SUFFIX}-prod"
